# 要件定義書

## 1. システム概要

### 1.1 目的
接骨院・整骨院向けのWeb予約システムを開発する。顧客がオンラインで予約を行い、店舗スタッフが予約や顧客情報を管理できるシステムを提供する。

### 1.2 対象ユーザー
- **顧客**: 予約を行う患者
- **スタッフ**: 予約や顧客情報を管理する店舗スタッフ
- **管理者**: システム全体の設定や管理を行うスタッフ

## 2. 機能要件

### 2.1 認証・アカウント管理

#### 2.1.1 認証方式
- **Email/パスワード認証**
  - Email形式のバリデーション
  - パスワード強度のバリデーション
  - ログイン機能
- **SSO認証**
  - 複数の認証プロバイダーに対応
  - プロバイダー選択UI
- **セッション管理**
  - セッションタイムアウト機能
  - タイムアウト時の入力情報保持

#### 2.1.2 メールアドレス確認
- 初回登録時のメールアドレス確認
- 確認メール送信機能
- 確認リンクからの認証完了処理

#### 2.1.3 パスワード管理
- パスワードリセット機能
- リセット用リンクのメール送信
- リセットリンクの有効期限管理

#### 2.1.4 スタッフアカウント
- 管理者によるスタッフアカウント発行
- ロール選択機能（管理者、スタッフ等）
- 初回ログイン用リンクの送信
- 初回ログイン時のパスワード設定

### 2.2 会員管理（顧客側）

#### 2.2.1 会員登録
- **必須項目**
  - 名前（姓名）
  - カナ（姓名）
  - Email
  - 電話番号
- **任意項目**
  - スポーツ実施有無
  - 競技名（スポーツ実施の場合）
  - 所属（スポーツ実施の場合）
- バリデーション機能
  - Email形式チェック
  - 電話番号桁数チェック
  - 必須項目チェック

#### 2.2.2 会員情報編集
- **編集可能な項目**
  - 名前（姓名）
  - カナ（姓名）
  - 電話番号
  - スポーツ実施有無
  - 競技名
  - 所属
  - 住所（郵便番号、都道府県、市区町村、番地、建物名）
  - 生年月日
  - 性別
  - 職業
  - 緊急連絡先（氏名、続柄、電話番号）
- **編集不可の項目**
  - Email（別途メールアドレス変更機能を使用）
- 確認画面での変更内容確認
- 変更内容の保存

#### 2.2.3 メールアドレス変更
- 新しいメールアドレスの入力
- 確認画面での確認
- 新メールアドレス宛の確認メール送信
- 確認リンクからの変更完了処理

#### 2.2.4 アカウント削除
- 削除前の警告表示
- 有効な予約がある場合の削除制限
- 予約履歴削除の通知
- 削除完了メールの送信

#### 2.2.5 顧客情報の詳細項目
顧客情報として保存する項目を以下に定義する。

- **基本情報（会員登録時に入力）**
  - 名前（姓名）- 必須
  - カナ（姓名）- 必須
  - Email - 必須
  - 電話番号 - 必須
  - パスワード（Email/パスワード認証の場合）- 必須
  - スポーツ実施有無 - 任意
  - 競技名（スポーツ実施の場合）- 任意
  - 所属（スポーツ実施の場合）- 任意

- **追加個人情報（初回来院時にタブレットで入力）**
  - 住所
    - 郵便番号 - 任意
    - 都道府県 - 任意
    - 市区町村 - 任意
    - 番地 - 任意
    - 建物名・部屋番号 - 任意
  - 生年月日 - 任意
  - 性別 - 任意
  - 職業 - 任意
  - 緊急連絡先 - 任意
    - 氏名
    - 続柄
    - 電話番号

- **問診情報（初回来院時にタブレットで入力）**
  - 来院目的 - 必須
  - 主な症状 - 必須
  - 症状の発生時期 - 任意
  - 症状の原因・きっかけ - 任意
  - 痛みの程度（10段階評価） - 任意
  - 既往歴 - 任意
  - 現在治療中の疾患 - 任意
  - 服用中の薬 - 任意
  - アレルギーの有無 - 任意
  - その他特記事項 - 任意

### 2.3 予約管理（顧客側）

#### 2.3.1 予約作成フロー
1. **メニュー選択**
   - メニュー一覧表示
   - メニュー詳細（名前、概要、料金、自費/保険区分）の表示
2. **スタッフ選択**
   - 管理者設定により省略可能
   - スタッフ一覧表示
   - スタッフ詳細（名前、画像）の表示
   - 担当可能なメニューでのフィルタリング
3. **日時選択**
   - カレンダー表示
   - スタッフの勤務時間を考慮した表示
   - 満席枠の選択不可表示
   - 予約受付時間外枠の選択不可表示
   - 予約枠の時間間隔は管理者設定に従う
4. **確認画面**
   - 選択内容の確認（メニュー、スタッフ、日時、会員情報）
   - 予約確定ボタン
5. **予約完了**
   - 確認メールの送信
   - マイページへの遷移

#### 2.3.2 予約一覧
- **表示項目**
  - 有効な予約
  - 過去の予約
  - キャンセル済みの予約
- **各予約の表示内容**
  - 予約日時
  - メニュー名
  - スタッフ名
  - ステータス

#### 2.3.3 予約詳細
- 予約の詳細情報表示
  - 予約日時
  - メニュー情報
  - スタッフ情報
  - ステータス
- 操作ボタン
  - 変更ボタン（変更期限内の場合）
  - キャンセルボタン（キャンセル期限内の場合）
  - メール再送信ボタン

#### 2.3.4 予約変更
- 変更期限のチェック
  - 期限内: 変更可能
  - 期限外: 変更ボタン無効化、店舗連絡を促すメッセージ表示
- 変更フロー
  1. 新しいスタッフ選択（任意）
  2. 新しい日時選択
  3. 確認画面での変更内容確認
  4. 変更確定
  5. 変更通知メールの送信
- 変更時の競合処理
  - 同時刻に別の予約が確定された場合のエラー表示
  - 別の日時選択を促すメッセージ

#### 2.3.5 予約キャンセル
- キャンセル期限のチェック
  - 期限内: キャンセル可能
  - 期限外: キャンセルボタン無効化、店舗連絡を促すメッセージ表示
- キャンセルフロー
  1. キャンセル確認画面
  2. キャンセル確定
  3. キャンセル通知メールの送信

### 2.4 通知機能（顧客側）

#### 2.4.1 予約確認メール
- 予約確定時の自動送信
- 含める情報
  - 予約日時
  - メニュー名
  - スタッフ名
  - 店舗情報（名前、住所、電話番号）

#### 2.4.2 メールアドレス確認メール
- 初回登録時および変更時の送信
- 確認用リンクの含有
- リンクの有効期限

#### 2.4.3 予約変更通知メール
- 予約変更確定時の自動送信
- 変更前後の情報を含む

#### 2.4.4 予約キャンセル通知メール
- 予約キャンセル確定時の自動送信
- 顧客側からのキャンセル
- 店舗側からのキャンセル（キャンセル理由を含む）

#### 2.4.5 リマインドメール
- 予約日前の自動送信
- 送信タイミングは管理者設定に従う（例: 前日10:00）
- 予約内容の確認情報を含む

#### 2.4.6 メール再送信機能
- マイページから確認メールの再送信
- 予約詳細画面に再送信ボタンを配置

### 2.5 店舗管理

#### 2.5.1 店舗情報登録・編集
- **登録項目**
  - 店舗名
  - 住所
  - 電話番号
  - その他店舗情報
- 初期セットアップ時の登録
- 編集機能

#### 2.5.2 営業時間設定
- **設定項目**
  - 曜日ごとの営業時間
  - 複数枠の営業時間に対応（例: 午前9-12時、午後14-18時）
  - 定休日の設定
- 編集機能

#### 2.5.3 臨時休業設定
- カレンダーからの日時選択
- 既存予約がある日時の制限
  - 既存予約がある場合: 選択不可（非活性表示）
  - 既存予約がない場合: 選択可能
- 休業設定の保存

### 2.6 メニュー管理

#### 2.6.1 メニュー登録
- **登録項目**
  - メニュー名
  - 概要
  - 画像（アップロード機能）
  - 料金（自費の場合）
  - 自費/保険適用の区分
- 保存機能

#### 2.6.2 メニュー編集
- 既存メニューの選択
- 登録項目の編集
- 保存機能

#### 2.6.3 メニュー削除
- 削除前のチェック
  - 既存予約がある場合: 警告表示、削除不可
  - 既存予約がない場合: 削除可能
- 削除後は新規予約で選択不可

### 2.7 スタッフ管理

#### 2.7.1 スタッフ情報登録
- **登録項目**
  - スタッフ名
  - スタッフ画像（アップロード機能）
  - 担当可能なメニュー（複数選択）
  - スタッフタイプ
    - 常勤
    - 非常勤
  - 出勤時間（常勤の場合）
- 保存機能

#### 2.7.2 スタッフ情報編集
- 既存スタッフの選択
- 登録項目の編集
- 保存機能

#### 2.7.3 スタッフ削除
- 削除前のチェック
  - 既存予約がある場合: 警告表示、削除不可
  - 既存予約がない場合: 削除可能
- 削除後は新規予約で選択不可

#### 2.7.4 シフト管理
- カレンダーからの日付選択
- **常勤スタッフ**
  - 休む時間の設定
  - デフォルトは出勤時間設定に従う
- **非常勤スタッフ**
  - 出勤する時間の指定
  - デフォルトは勤務なし
- 保存機能

### 2.8 予約設定

#### 2.8.1 基本設定
- **設定項目**
  - 予約枠の時間間隔（例: 30分、60分）
  - 1枠あたりの最大予約数
  - 予約受付期限（例: 3日前の23:59まで）
  - キャンセル受付期限（例: 前日の23:59まで）
  - 変更受付期限（例: 前日の23:59まで）
  - リマインドメール送信タイミング（例: 前日の10:00）
- 設定の保存

### 2.9 予約管理（店舗側）

#### 2.9.1 予約状況確認
- **カレンダー表示**
  - 日付選択
  - 日別の予約一覧表示
- **予約一覧の表示項目**
  - 時間枠
  - 顧客情報（名前）
  - メニュー情報
  - スタッフ情報
  - ステータス
- 予約詳細の確認

#### 2.9.2 直接予約（管理者側）
- フロー
  1. カレンダーから日時選択
  2. 新規予約ボタンをクリック
  3. 顧客を検索または新規作成
  4. メニュー選択
  5. スタッフ選択（任意）
  6. 予約確定
  7. 顧客に確認メール送信（任意）

#### 2.9.3 予約編集（管理者側）
- フロー
  1. 予約一覧から該当予約を選択
  2. 編集ボタンをクリック
  3. 日時、メニュー、スタッフなどを変更
  4. 変更確定
  5. 顧客に変更通知メール送信

#### 2.9.4 予約キャンセル（管理者側）
- フロー
  1. 予約一覧から該当予約を選択
  2. キャンセル理由を入力
  3. キャンセル実行
  4. 顧客にキャンセル通知メール送信

#### 2.9.5 来院確認
- フロー
  1. カレンダーから予約を選択
  2. 来院確認ボタンをクリック
  3. 来院時刻を記録
- 来院ステータスの更新

#### 2.9.6 No-show処理
- フロー
  1. カレンダーから予約を選択
  2. No-showボタンをクリック
  3. No-show理由を入力（任意）
  4. 顧客の予約履歴にNo-showを記録
- No-showステータスの更新

### 2.10 顧客管理（店舗側）

#### 2.10.1 顧客一覧・検索
- 顧客一覧表示
- 検索機能
  - 名前による検索
  - Email による検索
  - 電話番号による検索

#### 2.10.2 顧客詳細
- **表示項目**
  - 基本情報（2.2.5で定義された全項目）
    - 会員登録時の基本情報
    - 追加個人情報（住所、生年月日、性別、職業、緊急連絡先）
  - 問診情報（2.2.5で定義された問診項目）
  - 予約履歴
    - 予約日時
    - メニュー名
    - スタッフ名
    - ステータス
  - 来院履歴
    - 来院日時
    - メニュー名
    - スタッフ名
  - No-show履歴
    - 予約日時
    - 理由

#### 2.10.3 顧客情報編集
- **編集可能な項目**
  - 基本情報（名前、カナ、Email、電話番号）
  - スポーツ情報（実施有無、競技名、所属）
  - 追加個人情報（住所、生年月日、性別、職業、緊急連絡先）
  - 問診情報（2.2.5で定義された全問診項目）
- 変更履歴の記録（誰が、いつ、何を変更したか）
- 保存機能

#### 2.10.4 顧客直接作成
- フロー
  1. 新規顧客作成ボタンをクリック
  2. 顧客情報を入力
     - 基本情報（名前、カナ、Email、電話番号）- 必須
     - スポーツ情報（実施有無、競技名、所属）- 任意
     - 追加個人情報（住所、生年月日、性別、職業、緊急連絡先）- 任意
  3. 保存
- 管理者側で作成した顧客は、初回ログイン時にパスワード設定を行う

#### 2.10.5 初回問診入力
- フロー
  1. 顧客一覧から該当顧客を検索
  2. 初回問診ボタンをクリック
  3. タブレットで顧客に情報を入力してもらう
     - **追加個人情報**
       - 住所（郵便番号、都道府県、市区町村、番地、建物名）
       - 生年月日
       - 性別
       - 職業
       - 緊急連絡先（氏名、続柄、電話番号）
     - **問診情報**
       - 来院目的 - 必須
       - 主な症状 - 必須
       - 症状の発生時期
       - 症状の原因・きっかけ
       - 痛みの程度（10段階評価）
       - 既往歴
       - 現在治療中の疾患
       - 服用中の薬
       - アレルギーの有無
       - その他特記事項
  4. 入力された情報を確認・保存
- 入力された情報は顧客詳細に保存され、以降の来院時に参照可能

### 2.11 エラー処理

#### 2.11.1 重複予約の防止
- 予約確定時の在庫チェック
- 同時刻に別の予約が確定された場合
  - 満席エラーの表示
  - 別の日時選択を促すメッセージ
- トランザクション制御による排他制御

#### 2.11.2 ログイン失敗
- 認証情報の検証
- エラーメッセージの表示
  - 「メールアドレスまたはパスワードが正しくありません」
- 再入力を促す

#### 2.11.3 バリデーションエラー
- リアルタイムバリデーション
- エラーメッセージの表示
  - 各項目ごとのエラー表示
  - エラー箇所のハイライト
- 正しい形式での入力を促す

#### 2.11.4 ネットワークエラー
- エラーメッセージの表示
- 再試行ボタンの表示
- 予約完了状態が不明な場合の案内
  - マイページでの確認を促す

#### 2.11.5 セッションタイムアウト
- タイムアウト検知
- 再ログインを促す
- 入力情報の保持（可能な限り）

#### 2.11.6 予約変更時の競合
- 変更確定時の在庫チェック
- 同時刻に別の予約が確定された場合
  - 満席エラーの表示
  - 別の日時選択を促すメッセージ

## 3. 用語集

- **顧客**: 予約システムを利用する患者
- **スタッフ**: 予約や顧客情報を管理する店舗スタッフ
- **管理者**: システム全体の設定や管理を行うスタッフ
- **メニュー**: 施術内容（例: 保険診療、自費診療、マッサージ等）
- **予約枠**: 予約可能な時間単位（例: 30分、60分）
- **常勤**: 固定の出勤時間を持つスタッフ
- **非常勤**: 出勤時間が変動するスタッフ
- **No-show**: 予約したが来院しなかった状態
- **問診**: 初回来院時に記録する医療情報

## 4. 参照資料

- `spec/scenario.md`: 利用シナリオ
- `CLAUDE.md`: プロジェクトのコーディング規約
- `docs/implementation_example.md`: 実装例
