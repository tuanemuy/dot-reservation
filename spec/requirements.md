# 要件定義

## 1. ユーザー管理

### 1.1 顧客アカウント管理

#### 認証方式
- Email/パスワード認証
  - 会員登録時にEmail、パスワードを設定
  - メールアドレス確認機能（確認メール送信とリンククリックでの確認）
- SSO認証
  - 外部プロバイダー（Google、LINE等）を利用した認証

#### 会員情報
- 必須情報
  - 名前
  - カナ
  - Email
  - 電話番号
- オプション情報
  - スポーツをしているか
    - 競技名
    - 所属
  - 住所（初回来院時に入力）
  - 問診情報（初回来院時に入力）

#### アカウント操作
- 会員情報の変更
  - 基本情報（名前、電話番号等）の変更
  - メールアドレスの変更（新しいアドレス宛に確認メール送信）
- パスワードリセット
  - Email入力でパスワードリセット用リンクを送信
  - リンクから新しいパスワードを設定
- アカウント削除
  - 有効な予約がある場合は削除不可
  - 削除時に予約履歴も削除される旨を通知
  - 削除完了メールを送信

### 1.2 スタッフアカウント管理

#### アカウント発行
- 管理者権限を持つスタッフがアカウント発行
- ロール選択（管理者、スタッフ等）
- 発行されたEmailに初回ログイン用リンクを送信
- リンクからパスワード設定と初回ログイン

## 2. 店舗管理

### 2.1 店舗情報管理
- 基本情報
  - 店舗名
  - 住所
  - 電話番号
  - その他店舗情報

### 2.2 営業時間管理
- 曜日ごとの営業時間（複数枠対応）
- 定休日の設定
- 臨時休業の設定
  - カレンダーから日時を選択
  - 既存予約がある日時は選択不可
  - 既存予約がない日時のみ休業設定可能

## 3. メニュー管理

### 3.1 メニュー情報
- 名前
- 概要
- 画像
- 料金（自費の場合）
- 自費/保険適用の区分

### 3.2 メニュー操作
- 新規登録
- 編集
- 削除
  - 既存予約がある場合は削除不可（警告表示）
  - 既存予約がない場合のみ削除可能
  - 削除後は新規予約で選択不可

## 4. スタッフ管理

### 4.1 スタッフ情報
- スタッフ名
- スタッフ画像
- 担当可能なメニュー
- スタッフタイプ
  - 常勤
  - 非常勤
- 出勤時間（常勤の場合）

### 4.2 シフト管理
- カレンダーから日付を選択してシフト設定
- 常勤スタッフ：休む時間を設定
- 非常勤スタッフ：出勤する時間を設定

### 4.3 スタッフ操作
- 新規登録
- 編集
- 削除
  - 既存予約がある場合は削除不可（警告表示）
  - 既存予約がない場合のみ削除可能
  - 削除後は新規予約で選択不可

### 4.4 スタッフ選択の設定
- 管理者設定により、予約時のスタッフ選択を省略可能

## 5. 予約管理

### 5.1 予約設定
- 予約枠の時間間隔（例：30分、60分）
- 1枠あたりの最大予約数
- 予約受付期限（例：3日前の23:59まで）
- キャンセル受付期限（例：前日の23:59まで）
- 変更受付期限（例：前日の23:59まで）
- リマインドメール送信タイミング（例：前日の10:00）

### 5.2 予約の作成（顧客側）

#### 予約フロー
1. メニュー選択
2. スタッフ選択（任意・管理者設定により省略可）
3. 日時選択
   - スタッフの勤務時間を考慮した表示
   - 満席の枠は選択不可
   - 予約受付時間外の枠は選択不可
4. ログイン/会員登録
   - 初回：Email/パスワードまたはSSO
   - 2回目以降：ログインのみ
5. 会員情報入力（初回のみ）
6. 確認画面で入力内容を確認
7. 予約確定
8. 確認メールを受信

#### 初回来院時の追加情報入力
- スタッフ用端末で管理画面にアクセス
- 住所等のオプショナルな顧客情報
- 問診情報

### 5.3 予約の変更（顧客側）
1. マイページから予約一覧を表示
2. 該当予約を選択
3. 変更ボタンをクリック
   - 変更受付期限を過ぎている場合は無効化
   - 期限超過時は店舗に電話連絡を促すメッセージを表示
4. 新しいスタッフを選択（任意・管理者設定により省略可）
5. 新しい日時を選択（スタッフの勤務時間を考慮）
6. 確認画面で変更内容を確認
7. 変更確定
8. 変更通知メールを受信

### 5.4 予約のキャンセル（顧客側）
1. マイページから予約一覧を表示
2. 該当予約を選択
3. キャンセルボタンをクリック
   - キャンセル受付期限を過ぎている場合は無効化
   - 期限超過時は店舗に電話連絡を促すメッセージを表示
4. キャンセル確認
5. キャンセル完了
6. キャンセル通知メールを受信

### 5.5 予約一覧の閲覧（顧客側）
- マイページで以下を表示
  - 有効な予約
  - 過去の予約
  - キャンセル済みの予約
- 予約詳細の確認

### 5.6 予約の作成（管理者側）
1. 管理画面のカレンダー画面から日時を選択
2. 新規予約ボタンをクリック
3. 顧客を検索または新規作成
4. メニューを選択
5. スタッフを選択（任意）
6. 予約を確定
7. 顧客に確認メールを送信（任意）

### 5.7 予約の編集（管理者側）
1. 予約一覧から該当予約を選択
2. 編集ボタンをクリック
3. 日時、メニュー、スタッフなどを変更
4. 変更を確定
5. 顧客に変更通知メールを送信

### 5.8 予約のキャンセル（管理者側）
1. 予約一覧から該当予約を選択
2. キャンセル理由を入力
3. キャンセルを実行
4. 顧客にキャンセル通知メールを送信

### 5.9 予約状況の確認
- 管理画面のカレンダー画面で日付を選択
- その日の予約一覧を表示
  - 時間枠ごとの予約状況
  - 顧客情報
  - メニュー情報
- 予約詳細の確認

### 5.10 来院確認
1. 管理画面のカレンダー画面から予約一覧を表示
2. 該当予約を選択
3. 来院確認ボタンをクリック
4. 来院時刻を記録

### 5.11 No-show（無断キャンセル）処理
1. 管理画面のカレンダー画面から予約一覧を表示
2. 該当予約を選択
3. No-showボタンをクリック
4. No-show理由を入力（任意）
5. 顧客の予約履歴にNo-showを記録

## 6. 顧客管理

### 6.1 顧客情報の確認・編集
- 管理画面から顧客一覧を表示
- 顧客を検索
- 顧客詳細を表示
  - 基本情報
  - 予約履歴
  - 来院履歴
- 必要に応じて情報を編集

### 6.2 顧客の直接作成
1. 管理画面の顧客管理から新規顧客作成
2. 顧客情報を入力
   - 名前
   - カナ
   - Email
   - 電話番号
   - その他の情報
3. 保存

### 6.3 初診患者情報の入力
1. 管理画面の顧客管理から該当顧客を検索
2. 初回問診ボタンをクリック
3. タブレットで顧客に情報を入力してもらう
   - 住所等オプショナルな個人情報
   - 一般的な問診
4. 入力された情報を確認・保存

## 7. 通知機能

### 7.1 送信するメール
- 予約確認メール（予約作成時）
- メールアドレス確認メール（会員登録時、メールアドレス変更時）
- 予約変更通知メール（予約変更時）
- キャンセル通知メール（予約キャンセル時）
- リマインドメール（予約日の前日または設定された期間前）
- パスワードリセットメール（パスワードリセット時）
- アカウント削除完了メール（アカウント削除時）

### 7.2 メール再送信
- マイページの予約詳細画面からメール再送信ボタンをクリック
- 確認メールを再送信

## 8. エラーハンドリング

### 8.1 重複予約の防止
- 予約確定時に該当枠が満席になっていないかチェック
- 満席の場合はエラーメッセージを表示
- 別の日時を選択するよう促す

### 8.2 予約変更時の競合
- 予約変更確定時に新しい日時が満席になっていないかチェック
- 満席の場合はエラーメッセージを表示
- 別の日時を選択するよう促す

### 8.3 ログイン失敗
- 認証情報が間違っている場合はエラーメッセージを表示
- 再入力を促す

### 8.4 バリデーションエラー
- Email形式が不正
- 電話番号の桁数が不正
- その他入力値の不正
- バリデーションエラーを表示し、正しい形式での入力を促す

### 8.5 ネットワークエラー
- 予約確定時にネットワークエラーが発生した場合
- エラーメッセージを表示
- 再試行ボタンを表示
- 予約が完了したか不明な場合は、マイページで確認するよう促す

### 8.6 セッションタイムアウト
- ログイン後、長時間操作しない場合
- 予約確定時にセッションタイムアウトエラー
- 再ログインを促す
- 入力情報は可能な限り保持

### 8.7 メニュー削除時の既存予約への影響
- メニュー削除時に既存予約がある場合は警告を表示
- 既存予約がない場合のみ削除可能
- 削除されたメニューは新規予約で選択不可

### 8.8 スタッフ削除時の既存予約への影響
- スタッフ削除時に既存予約がある場合は警告を表示
- 既存予約がない場合のみ削除可能
- 削除されたスタッフは新規予約で選択不可

## 9. UI/UX要件

### 9.1 顧客側画面
- トップページ
  - メニュー一覧の表示
- メニュー選択画面
- スタッフ選択画面（管理者設定により省略可）
- カレンダー画面
  - スタッフの勤務時間を考慮した表示
  - 満席枠は選択不可として表示
  - 予約受付時間外の枠は選択不可として表示
- ログイン画面
  - Email/パスワードログイン
  - SSO（外部プロバイダー）ログイン
  - パスワードを忘れたリンク
- 会員登録フォーム
- 確認画面（予約内容、会員情報の確認）
- マイページ
  - 予約一覧（有効、過去、キャンセル済み）
  - 会員情報編集
  - メールアドレス変更
  - アカウント設定
  - アカウント削除

### 9.2 管理者側画面
- 管理画面ダッシュボード
- カレンダー
  - 日付選択
  - 予約一覧表示
  - 新規予約作成
- 予約管理
  - 予約一覧
  - 予約詳細
  - 予約編集
  - 予約キャンセル
  - 来院確認
  - No-show処理
- 顧客管理
  - 顧客一覧
  - 顧客検索
  - 顧客詳細
  - 顧客情報編集
  - 顧客新規作成
  - 初回問診入力
- メニュー管理
  - メニュー一覧
  - メニュー新規登録
  - メニュー編集
  - メニュー削除
- スタッフ管理
  - スタッフ一覧
  - スタッフ新規登録
  - スタッフ編集
  - スタッフ削除
  - シフト管理
- 営業時間管理
  - 曜日ごとの営業時間設定
  - 定休日設定
  - 臨時休業設定
- 店舗情報管理
  - 店舗基本情報編集
- 予約設定管理
  - 予約枠の時間間隔
  - 1枠あたりの最大予約数
  - 予約受付期限
  - キャンセル受付期限
  - 変更受付期限
  - リマインドメール送信タイミング
  - スタッフ選択の省略設定
- スタッフアカウント管理
  - スタッフアカウント一覧
  - スタッフアカウント発行
  - ロール管理

## 10. 非機能要件

### 10.1 パフォーマンス
- カレンダー表示のレスポンス時間は2秒以内
- 予約確定処理は3秒以内に完了

### 10.2 セキュリティ
- パスワードは適切にハッシュ化して保存
- SSO認証の実装
- セッション管理とタイムアウト
- CSRF対策
- XSS対策
- SQLインジェクション対策

### 10.3 可用性
- メール送信失敗時の再送信機能
- ネットワークエラー時の再試行機能

### 10.4 保守性
- コードは Hexagonal Architecture + DDD で実装
- エラーログの記録と監視

### 10.5 ブラウザ対応
- モダンブラウザ（Chrome、Firefox、Safari、Edge）の最新2バージョン
- モバイルブラウザ対応
